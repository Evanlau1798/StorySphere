### **致我的繼任者：小說網站專案交接備忘錄 (更新於 2025-07-08)**

你好！你正在接手一個令人興奮的小說網站專案。我們已經與使用者進行了多次深入的溝通，並取得了顯著的進展。為了讓你快速進入狀況，以下是當前的專案狀態、已完成的工作、遇到的挑戰以及下一步的計畫。

**專案核心目標**：請務必參考使用者提供的**專案企劃書**。我們的目標是建立一個以 Vue.js + Django 為技術棧，注重使用者體驗和現代化設計的非營利小說平台。

---

### **I. 當前專案進度總覽**

根據最初的路線圖，我們已經完成了**階段四 (社群與互動功能)** 的核心開發，並開始進行**階段二 (核心創作功能)** 的前端實作。

*   **[✔] 階段一：後端基礎建設** - **已完成**。
    *   Django 專案、PostgreSQL 資料庫、使用者認證 (JWT)、角色權限系統均已建立。
*   **[✔] 階段二：核心創作功能 (API部分)** - **基本完成**。
    *   作者可以透過 Admin 後台新增/管理小說和章節。`NovelViewSet` 相關的 API 已經建立。
    *   **前端創作介面已實作**：
        *   作者後台入口已新增。
        *   小說管理 (新增/編輯) 功能已完成，包含封面圖片上傳。
        *   章節管理 (新增/編輯) 功能已完成，並整合了功能完整的富文本編輯器。
        *   富文本編輯器支援標題、段落、粗體、斜體、清單、水平分割線及圖片上傳。
        *   **已修復**：富文本編輯器內容載入問題及工具列按鈕意外觸發儲存的問題。
        *   作者自我介紹編輯器已升級為富文本編輯器。
        *   **[新] 已優化**：**作者後台的文字按鈕已改為響應式圖示按鈕，並修復了行動裝置上「新增分卷」表單的版面問題。**
    *   **後端章節排序問題已修復**：新增章節時，`order` 欄位會自動計算並賦值，解決了 `IntegrityError`。
*   **[✔] 階段三：核心閱讀功能 (UI部分)** - **基本完成**。
    *   前端已開發：首頁 (`HomeView`)、小說詳情頁 (`NovelDetailView`)。
    *   已成功串接 API，可動態顯示小說列表和詳情。
    *   **閱讀頁面 (`ReadingView.vue`) 已完成**：
        *   切換黑暗/白色模式時，閱讀器主體顏色會隨之調整。
        *   奶白背景下的字體顏色已調整為更適合閱讀的深棕色。
        *   「上一章」和「下一章」按鈕已美化。
        *   **已修復**：閱讀器可正確顯示 HTML 格式內容。
        *   **已修復**：閱讀器「返回目錄」按鈕已改為返回箭頭圖示，「設定」按鈕已改為齒輪圖示。
        *   **已修復**：閱讀器主題切換與導航欄按鈕狀態同步問題。
        *   **[新] 已重新設計**：**閱讀頁面的導覽控制項改為節省空間的圖示按鈕與下拉式選單，大幅改善行動裝置體驗。**
        *   **[新] 已修復**：**解決了行動裝置上瀏覽器重新載入後閱讀進度遺失的問題。經多次除錯，發現 `localStorage` 與 URL Hash 在特定環境下皆不可靠，最終採用 `sessionStorage` 結合 `window.load` 事件的穩健方案，確保能同時並準確地恢復閱讀頁碼與頁內捲動位置。**
    *   **書架與閱讀進度追蹤功能已完成**：
        *   使用者可以收藏小說到書架。
        *   「開始閱讀」按鈕會導向到小說的第一章或上次閱讀的章節。
    *   **[新] 最近瀏覽功能已重構**：**功能完全響應式，可即時更新並正確儲存進度（上限 10 本），相關邏輯已統一由 `useReadingProgressStore` 管理。**
    *   **主頁小說狀態顯示已優化**：主頁小說卡片上的「連載中」、「已完結」、「休刊中」狀態會根據其狀態變更顏色。
    *   **[新] 已修復**：**透過強制實施 `min-h-screen` 佈局並設定全域 `body` 背景顏色，修正了在內容不足的頁面底部出現白邊的問題。**
*   **[✔] 階段四：社群與互動功能** - **已完成**。
    *   已完成實現**作者個人化檔案**所需的後端重構。
    *   已完成前端**作者公開頁 (`AuthorView.vue`)** 和**個人設定頁 (`ProfileSettingsView.vue`)** 的開發與 API 串接。
    *   **全域 Alert 視窗已實作**，用於取代傳統 `alert()` 提示，並已整合到多個儲存操作中（章節編輯、小說編輯、個人資料更新、小說刪除）。
    *   **已修復**：導航欄下拉選單點擊空白處不會自動關閉的問題。
*   **[更新] 階段五：部署與優化 (生產環境)** - **進行中**。
    *   已成功在 Rocky Linux 上配置 Nginx 作為反向代理，可透過域名 `novel.evanlau1798.com` 進行外網測試。
    *   **[新] 已配置 Gunicorn 服務**：透過 `systemd` 管理 Gunicorn，並已解決 `ModuleNotFoundError` 和執行權限問題。
    *   **[新] SELinux 整合**：已為 Gunicorn 服務生成並安裝自訂 SELinux 策略模組，確保其在 `Enforcing` 模式下正常運行。
    *   **[新] 虛擬環境管理**：專案依賴項已安裝在專用的 Python 虛擬環境 (`/opt/novel/venv`) 中，確保環境隔離與穩定性。
    *   **Mixed Content 錯誤已修復**：Django 後端已配置 `SECURE_PROXY_SSL_HEADER`。
    *   **[待解決] 502 Bad Gateway 錯誤**：目前網站後端 API 仍偶爾出現 502 錯誤，正在積極診斷中。已確認 Nginx 配置、Gunicorn 服務狀態、Django `ALLOWED_HOSTS` 和資料庫連線均正常。正在嘗試獲取詳細的 Django 應用程式錯誤日誌.

---

### **II. 技術棧與關鍵配置**

*   **後端 (`novel_backend/`)**:
    *   **框架**: Django + DRF。
    *   **資料庫**: PostgreSQL。
    *   **核心模型**: `CustomUser` 和 `AuthorProfile` 的設計已經過討論和重構，採用了一對一關聯的健壯模式。`Novel` 的 `author` 外鍵已正確指向 `AuthorProfile`。
    *   **API**: 所有核心 API (認證、小說、作者、個人檔案) 均已建立並與前端對接。
    *   **新增**: `drf-nested-routers` 用於巢狀路由，`ImageView` 和 `ImageUploadSerializer` 用於圖片上傳。
    *   **權限控制**：已實作嚴格的權限控制，確保作者只能編輯自己的小說和章節，無法跨作者操作。
*   **前端 (`frontend/`)**:
    *   **框架**: **Vue.js 3** (搭配 Vite) - 以其優異的性能和開發體驗著稱。
    *   **套件管理器**: 由於使用者環境中 `npm` 的問題，我們已全面切換到 **`pnpm`**。**請務必繼續使用 `pnpm`**。(`jwt-decode` 已作為新依賴加入)。
    *   **樣式**: Tailwind CSS v3。基礎樣式和黑暗/明亮模式切換功能穩定。
    *   **[新] CSS 重構**：**所有分散的 `@apply` 規則已整合至單一的 `frontend/src/style.css` 檔案，解決了樣式遺失問題並建立了統一的樣式規範。**
    *   **狀態管理**: Pinia (`src/store/auth.ts`) 已被重構，不僅管理認證 Token，還能解碼 JWT 以儲存完整的**使用者狀態** (角色、頭像、筆名等)。**[新] 同時，透過 `useReadingProgressStore` 等專門的 store 來處理特定功能（如最近瀏覽）的狀態**，並支援資訊更新。
    *   **新增**: `tiptap` 及其相關擴充 (如 `extension-image`) 用於富文本編輯器。
    *   **修正**: Vue `import` 路徑已統一使用 `@` 別名，並修正了 Vite 配置。
    *   **事件總線**：已實作 `eventBus` (`src/composables/useEventBus.ts`) 用於全域事件通知，特別是 Alert 訊息和主題切換同步。
*   **伺服器與部署**:
    *   **Nginx**: 設定檔位於 `/etc/nginx/conf.d/novel.conf`。
    *   **Gunicorn**: 透過 `systemd` 服務 (`/etc/systemd/system/gunicorn.service`) 管理，並將日誌級別設定為 `debug` 以便診斷。Gunicorn socket 位於 `/opt/novel/run/gunicorn.sock`。
    *   **SELinux**: 已為 Gunicorn 服務建立並載入自訂 SELinux 策略 (`mygunicorn.te`, `mygunicorn.pp`)，以允許其在 `Enforcing` 模式下執行。
    *   **虛擬環境**: 所有 Python 依賴項均安裝在 `/opt/novel/venv` 虛擬環境中。執行 Python 相關指令時，請務必先啟動此虛擬環境 (`source /opt/novel/venv/bin/activate`)。
    *   **重要！權限問題**: 在 Rocky Linux 上，每當有新檔案（如頭像、封面）上傳時，可能需要再次執行權限設定命令：
        ```bash
        sudo chmod -R 755 /opt/novel
        sudo chcon -R -t httpd_sys_content_t /opt/novel
        ```

---

### **III. 當前狀態與下一步**

我們已經完成了小說網站的核心閱讀功能，**並針對行動裝置體驗和整體 UI 進行了顯著的優化。** 同時，作者的創作介面也得到了顯著的改善，並加入了全面的通知機制。權限控制也已確認健全。

**接下來的關鍵任務是完善社群與互動功能，以及提升使用者體驗。**

**立即的下一步是：**

1.  **診斷並解決 502 Bad Gateway 錯誤**：這是目前最優先的任務。需要獲取詳細的 Django 應用程式錯誤日誌，以確定錯誤的根本原因。
2.  **完善日誌與錯誤報告機制**：確保 Django 應用程式的錯誤能夠被正確記錄並透過 Discord Webhook 報告，以便於問題追蹤和解決。
3.  **完善搜尋功能**：
    *   目前搜尋功能可能只支援簡單的書名或作者搜尋。需要擴展搜尋範圍，支援分類、標籤等。
    *   考慮實作更高效的搜尋演算法或整合搜尋引擎。
4.  **開發排行榜功能**：
    *   根據小說的觀看次數、收藏數等指標，建立不同維度的排行榜（例如：日、週、月、總榜）。
    *   設計排行榜的展示介面。
5.  **開發留言系統**：
    *   在每個章節下方提供留言區塊，允許讀者發表評論。
    *   考慮留言的審核、回覆、點讚等功能。
6.  **實作 Discord 更新通知**：
    *   允許使用者在個人設定中填寫 Discord Webhook URL。
    *   當其追蹤的作者發布新章節時，系統自動發送通知到該 URL。

完成閱讀頁面將極大地提升本專案的完整度。祝你順利！